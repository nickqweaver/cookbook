# =============================================================================
# Cookbook Docker Compose Configuration
# =============================================================================
# This file orchestrates the cookbook application container.
#
# Usage:
#   1. Copy .env.example to .env and fill in your values
#   2. Run: docker compose up -d
#   3. Run migrations: docker compose exec cookbook npm run db:migrate
#   4. Access the app at http://localhost:42069
#
# Why Docker Compose?
# - Simplifies running containers with volumes and environment variables
# - One command to start everything: docker compose up -d
# - Easy to add more services later (nginx, backups, etc.)
# =============================================================================

services:
  cookbook:
    # Build from the Dockerfile in the current directory
    build:
      context: .
      dockerfile: Dockerfile

    # Container name for easy reference
    container_name: cookbook

    # Restart policy: always restart unless explicitly stopped
    # This ensures the app comes back up after server reboots
    restart: unless-stopped

    # Port mapping: host:container
    # Access the app at http://localhost:42069 (or your server's IP)
    ports:
      - '42069:3000'

    # Environment variables
    # These override the defaults in the Dockerfile
    environment:
      - NODE_ENV=production
      # DATABASE_URL points to a file inside the mounted volume
      # This ensures data persists even if the container is rebuilt
      - DATABASE_URL=/app/data/cookbook.db
      # OpenAI API key for the recipe stealing feature
      - OPENAI_API_KEY=${OPENAI_API_KEY}

    # Volume mounts for data persistence
    # ./data on your host maps to /app/data in the container
    # Your SQLite database lives here and survives container rebuilds
    volumes:
      - ./data:/app/data

    # Health check to verify the app is running
    # Docker will mark the container as unhealthy if this fails
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:3000']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
